name: Build and Release Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.3.0)'
        required: true
        default: '1.3.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Build Tablet UI APK
      run: ./build-tablet-ui-apk.sh
      
    - name: Get version info
      id: version
      run: |
        VERSION=$(grep "versionName" app/build.gradle | grep -o '"[^"]*"' | tr -d '"')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Copilot Android Client v${{ steps.version.outputs.version }}
        body: |
          ## ðŸš€ Copilot Android Client v${{ steps.version.outputs.version }}
          
          ### ðŸ“± Tablet UI Optimization Release
          
          **What's New:**
          - ðŸ†• **Tablet Support**: Dedicated layouts for tablets (sw600dp)
          - ðŸ†• **Landscape Mode**: Optimized two-column layout for landscape
          - ðŸ†• **Enhanced Keyboard**: Additional Clear and History buttons on tablets
          - ðŸ†• **Responsive Design**: Adaptive layouts for all screen sizes
          - âœ… **Better Compatibility**: Improved Android 15 support
          - âœ… **Enhanced Touch Targets**: Larger buttons for tablet use
          
          **System Requirements:**
          - Android 12 (API 31) or higher
          - Recommended: 7"+ tablets for optimal experience
          - Phones: 5"+ recommended
          
          **Installation Instructions:**
          1. Enable "Install Unknown Apps" in Android settings
          2. Download the APK below
          3. Install on your device
          4. Configure your Copilot server URL in the app
          
          **Server Setup:**
          Use the included server scripts to set up your Copilot CLI server.
          
          ### ðŸ”§ Technical Details
          - Target SDK: 34 (Android 14) for better compatibility
          - Min SDK: 31 (Android 12)
          - Package: com.ssfdre38.cpcli.android.client
          - Enhanced for tablets and landscape mode
          - Signed with debug key for compatibility
          
        draft: false
        prerelease: false
        
    - name: Upload APK to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./copilot-android-client-v${{ steps.version.outputs.version }}-tablet-ui-release.apk
        asset_name: copilot-android-client-v${{ steps.version.outputs.version }}-tablet-ui-release.apk
        asset_content_type: application/vnd.android.package-archive
        
    - name: Upload APK Info to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./copilot-android-client-v${{ steps.version.outputs.version }}-tablet-ui-release.apk.info
        asset_name: copilot-android-client-v${{ steps.version.outputs.version }}-tablet-ui-release-info.txt
        asset_content_type: text/plain