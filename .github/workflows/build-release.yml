name: Build and Release Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.3.0)'
        required: true
        default: '1.3.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Build Stable Installable APK
      run: ./build-stable-apk.sh
      
    - name: Get version info
      id: version
      run: |
        VERSION=$(grep "versionName" app/build.gradle | grep -o '"[^"]*"' | tr -d '"')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Copilot Android Client v${{ steps.version.outputs.version }}
        body: |
          ## ğŸš€ Copilot Android Client v${{ steps.version.outputs.version }}
          
          ### ğŸ“± Installation Fixed Release
          
          **âœ… APK Installation Issues RESOLVED**
          This release fixes the "invalid package" errors that prevented APK installation on Android devices.
          
          **What's Fixed:**
          - âœ… **APK Installation**: Now installs properly on all Android devices
          - âœ… **Package Manager**: No more "invalid package" errors
          - âœ… **Signing**: Proper Android debug keystore signing
          - âœ… **Compatibility**: Works on Android 7.0+ through Android 15
          
          **Features:**
          - ğŸ¤– **Native Android Client** for GitHub Copilot CLI
          - ğŸ“± **Material Design 3** UI with tablet support
          - âŒ¨ï¸ **Essential Keyboard Shortcuts** (Ctrl+C, Tab, Enter, etc.)
          - ğŸ” **Auto Server Discovery** on local network
          - ğŸ’¬ **Chat History** with search functionality
          - ğŸŒ™ **Dark Mode** support
          - ğŸ”§ **Multi-Server Support**
          - ğŸ“¤ **Import/Export** settings
          
          **System Requirements:**
          - Android 7.0 (API 24) or higher
          - Internet connection for server communication
          
          **Installation Instructions:**
          1. Download the APK below
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK - it should now install without errors!
          4. Configure your Copilot server URL in the app
          
          **Server Setup:**
          Use the included server scripts to set up your Copilot CLI server.
          
          ### ğŸ”§ Technical Details
          - Target SDK: 34 (Android 14)
          - Min SDK: 24 (Android 7.0)
          - Package: com.ssfdre38.cpcli.android.client
          - Build Type: Debug (Properly Signed)
          - Installation: Fixed - works on all Android versions
          
        draft: false
        prerelease: false
        
    - name: Upload APK to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./copilot-android-client-v${{ steps.version.outputs.version }}-stable-debug.apk
        asset_name: copilot-android-client-v${{ steps.version.outputs.version }}-stable-debug.apk
        asset_content_type: application/vnd.android.package-archive
        
    - name: Upload APK Info to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./copilot-android-client-v${{ steps.version.outputs.version }}-stable-debug.apk.info
        asset_name: copilot-android-client-v${{ steps.version.outputs.version }}-stable-debug-info.txt
        asset_content_type: text/plain